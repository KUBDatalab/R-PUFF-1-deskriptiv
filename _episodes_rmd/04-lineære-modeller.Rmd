---
title: "Lineære modeller"
teaching: 10
exercises: 5
questions:
- "Hvordan fitter jeg en lineær model i R?"
objectives:
- "FIXME"
keypoints:
- "FIXME"
source: Rmd
---

```{r, include = FALSE}
source("../bin/chunk-options.R")
knitr_fig_path("04-")
# source("../bin/download_data.R")
library(tidyverse)
```
# NB - denne side er til dag 2 - og ikke helt færdig.


Vi genbesøger lige fev datasættet:

```{r eval = F}
fev <- read_csv("data/FEV.csv")
```
```{r echo = F}
fev <- read_csv("../data/FEV.csv")
```

Det så således ud:
```{r}
fev %>% head()
```

Inden man bygger modeller, er det en god ide at lave et scatterplot:

```{r}
plot(FEV ~ Hgt, dat = fev)
```

Det kunne godt se lineært ud.


Når vi laver en lineær model, skal vi angive modellen på en særlig måde. 
I R kaldes det for `formel-notation` og `FEV ~ Hgt` dækker over at vi godt vil
forklare FEV som funktion af Hgt. Altså en model hvor vi forestiller os at 
Forced Expiratory Volume er en lineær funktion af børnenes højde.

Funktionen der laver vores lineære model hedder `lm()` og skal også have at vide,
at det data vi bruger, hedder fev:

```{r}
model <- lm(FEV ~ Hgt, data = fev)
```

Det output vi får direkte er ikke særligt nyttigt. Derfor gemmer vi resultatet i
et objekt, her kalder vi det `model`. 

Outputtet direkte ser således ud:

```{r}
model
```

Det giver os skæring og hældning. Men vi vil godt vide lidt mere:

```{r}
summary(model)
```

Ikke meget lineær. men ret.


Prøv selv!

> ## Øvelse
>
> Download datasættet BONEDEN til din datamappe
>
> https://raw.githubusercontent.com/KUBDatalab/R-PUFF/main/data/BONEDEN.csv
>
> Indlæs det derefter med read_csv til et objekt. Kald objektet boneden (med små bogstaver)
>
> Lav dernæst en lineær regression af `tea1` mod `cof1`
>
> > ## Løsning
> > download.file("https://raw.githubusercontent.com/KUBDatalab/R-PUFF/main/data/BONEDEN.csv", "data/BONEDEN.csv", mode = "wb")
> > 
> > boneden <- read_csv("data/BONEDEN.csv)
> >
> > lm(tea1 ~ cof1, data = boneden)
> > 
> >   select(-iso2, -iso3, -new)
> {: .solution}
{: .challenge}


> ## Øvelse 2 - spredning og middelværdier på indtag af te.
>
> Fortsæt arbejdet med datasættet boneden
>
> Beregn middelværdi, median og standardafvigelser på indtaget af te (`tea1`)
> og kaffe (`cof1`)
>
> Lav et scatterplot af `tea1` mod `cof1` 
>
> > ## Løsning
> > 
> > mean(boneden$tea1)
> >
> > mean(boneden$cof1)
> > 
> > median(boneden$tea1)
> > 
> > median(boneden$cof1)
> > 
> > plot(boneden$tea1, boneden$cof1)
> >
> > eller:
> >
> > boneden %>% 
> >
> >   ggplot(aes(x = cof1, y = tea1)) +
> >
> >   geom_point()
> >
> {: .solution}
{: .challenge}


Undertiden kan vi have behov for at få resultaterne ud i en tabel.

Hvis vi installerer pakken `broom`, får vi adgang til funktion `tidy()` der
piller de mest interessante data ud til os:
```{r}
library(broom)
tidy(model)
```

Og vil vi have et endnu mere lækkert format, kan vi installere pakken `stargazer`,
der har en funktion der hedder - wait for it - `stargazer()` der kan formattere
ting pænt for os. Her vælger vi `type="text"` der egner sig fint til dette 
output format, men andre muligheder findes:
```{r}
library(stargazer)
stargazer(model, type="text")
```



Det kunne godt se lineært ud. Går vi over i `ggplot`-universet, kan vi relativt
let lave det samme, nu med en lineær regressionslinie lagt ind også:

```{r}
fev %>% 
  ggplot(aes(x = Hgt, y = FEV)) +
  geom_point() +
  geom_smooth(method="lm")
```

Det er `method="lm"` der angiver at det skal være en lineær linie der skal
ligges ind. 

Hvis vi godt vil have konfidensintervaller på parametrene i vores model, er der 
en funktion til det:

```{r}
confint(model)
```


Vi har tidligere lært, at den nedre værdi for konfidensintervallet, finder vi
ved at trække 1.96 ganget med standardfejlen fra estimatet. Og den øvre 
ved at lægge til i stedet. Lad os lige tjekke efter:

```{r}
0.131976 + c(-1, 1)* 1.96* 0.002955
```
Det stemmer ikke helt. Det skyldes at 1.96 ikke er den _helt_ rigtige værdi.

Hvis vi godt vil have den helt præcist kan vi få det:

```{r echo  =F}
options(digits = 17)
```

```{r}
qt(0.975, nrow(fev)-2)
```
```{r echo =F}
options(digits = 7)
```

1.96 er nok til de fleste formål.

Hvis vi ikke vil nøjes med et 95% interval, kan vi specificere et andet:

```{r}
confint(model, level = 0.99)
```



Dette kunne også være en øvelse:
```{r}
drenge <- fev %>% 
  filter(Sex == 0)

piger <- fev %>% 
  filter(Sex == 1)


```

```{r}
lm(FEV ~ Hgt, data = drenge) %>% summary()
```
```{r}
lm(FEV ~ Hgt, data = piger) %>% summary()
```

## Et andet datasæt


{% include links.md %}
